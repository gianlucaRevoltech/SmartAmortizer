<div class="container">
  <div class="left-column">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>{{
          showNewLoanForm ? "Aggiungi Nuovo Finanziamento" : "Opzioni"
        }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <button
          mat-stroked-button
          color="primary"
          (click)="showNewLoanForm = !showNewLoanForm"
          class="add-loan-button"
        >
          <mat-icon>{{ showNewLoanForm ? "close" : "add" }}</mat-icon>
          {{ showNewLoanForm ? "Annulla" : "Nuovo Finanziamento" }}
        </button>

        <app-new-loan
          *ngIf="showNewLoanForm"
          (newLoan)="addNewLoan($event)"
        ></app-new-loan>
      </mat-card-content>
    </mat-card>

    <mat-card class="loan-list-card">
      <mat-card-header>
        <mat-card-title>Seleziona un finanziamento</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-list>
          <mat-list-item
            *ngFor="let item of loanItems"
            (click)="selectLoanItem(item)"
            [class.selected]="item === selectedLoanItem"
            class="loan-item"
          >
            <mat-icon mat-list-icon>{{ getItemIcon(item.type) }}</mat-icon>
            <div mat-line>{{ item.name }}</div>
            <div mat-line class="loan-type">{{ item.type }}</div>
            <button
              mat-icon-button
              color="warn"
              (click)="deleteLoan(item, $event)"
              class="delete-button"
              matTooltip="Elimina finanziamento"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="right-column">
    <ng-container *ngIf="selectedLoanItem; else noLoanSelected">
      <mat-card class="loan-details-card">
        <mat-card-header>
          <mat-card-title>{{ selectedLoanItem.name }}</mat-card-title>
          <mat-card-subtitle>{{ selectedLoanItem.type }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">Importo Finanziato:</span>
              <span class="detail-value">{{
                selectedLoanItem.totalAmount
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Totale da Restituire:</span>
              <span class="detail-value total-amount">{{
                getTotalAmountToPay(selectedLoanItem)
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ancora da Pagare:</span>
              <span class="detail-value remaining-amount">{{
                getRemainingAmountToPay(selectedLoanItem)
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Interessi Totali:</span>
              <span class="detail-value interest-amount">{{
                getTotalInterests(selectedLoanItem)
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Capitale Residuo:</span>
              <span class="detail-value">{{
                selectedLoanItem.remainingAmount
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">T.A.N.:</span>
              <span class="detail-value"
                >{{ selectedLoanItem.interestRate }}%</span
              >
            </div>
            <div class="detail-item" *ngIf="selectedLoanItem.taeg">
              <span class="detail-label">T.A.E.G.:</span>
              <span class="detail-value taeg-amount"
                >{{ selectedLoanItem.taeg }}%</span
              >
            </div>
            <div class="detail-item">
              <span class="detail-label">Rate Pagate:</span>
              <span class="detail-value"
                >{{ selectedLoanItem.paidInstallments }} /
                {{ selectedLoanItem.installments }}</span
              >
            </div>
            <!-- Additional Car Financing Details -->
            <div class="detail-item" *ngIf="selectedLoanItem.vehiclePrice">
              <span class="detail-label">Prezzo Veicolo:</span>
              <span class="detail-value">{{
                selectedLoanItem.vehiclePrice
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedLoanItem.downPayment">
              <span class="detail-label">Anticipo:</span>
              <span class="detail-value">{{
                selectedLoanItem.downPayment
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedLoanItem.totalServices">
              <span class="detail-label">Totale Servizi:</span>
              <span class="detail-value">{{
                selectedLoanItem.totalServices
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedLoanItem.practiceExpenses">
              <span class="detail-label">Spese Istruttoria:</span>
              <span class="detail-value">{{
                selectedLoanItem.practiceExpenses
                  | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
              }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="amortization-table-card">
        <mat-card-header>
          <mat-card-title>Piano di Ammortamento</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="selectedLoanItem.amortizationPlan"
              class="mat-elevation-z8"
            >
              <!-- Colonna Rata -->
              <ng-container matColumnDef="installment">
                <th mat-header-cell *matHeaderCellDef># Rata</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.installment }}
                </td>
              </ng-container>

              <!-- Colonna Data Pagamento -->
              <ng-container matColumnDef="paymentDate">
                <th mat-header-cell *matHeaderCellDef>Data Pagamento</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.paymentDate | date : "dd/MM/yyyy" }}
                </td>
              </ng-container>

              <!-- Colonna Importo -->
              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Importo Rata</th>
                <td mat-cell *matCellDef="let element">
                  {{
                    element.amount
                      | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
                  }}
                </td>
              </ng-container>

              <!-- Colonna Capitale -->
              <ng-container matColumnDef="principal">
                <th mat-header-cell *matHeaderCellDef>Quota Capitale</th>
                <td mat-cell *matCellDef="let element">
                  {{
                    element.principal
                      | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
                  }}
                </td>
              </ng-container>

              <!-- Colonna Interessi -->
              <ng-container matColumnDef="interest">
                <th mat-header-cell *matHeaderCellDef>Quota Interessi</th>
                <td mat-cell *matCellDef="let element">
                  {{
                    element.interest
                      | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
                  }}
                </td>
              </ng-container>

              <!-- Colonna Debito Residuo -->
              <ng-container matColumnDef="remainingBalance">
                <th mat-header-cell *matHeaderCellDef>Debito Residuo</th>
                <td mat-cell *matCellDef="let element">
                  {{
                    element.remainingBalance
                      | currency : "EUR" : "symbol" : "1.2-2" : "it-IT"
                  }}
                </td>
              </ng-container>

              <!-- Colonna Stato -->
              <ng-container matColumnDef="paid">
                <th mat-header-cell *matHeaderCellDef>Stato</th>
                <td mat-cell *matCellDef="let element">
                  <mat-chip
                    [color]="element.paid ? 'primary' : 'warn'"
                    disabled
                  >
                    {{ element.paid ? "Pagata" : "Da Pagare" }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Colonna Azione -->
              <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef>Azione</th>
                <td mat-cell *matCellDef="let element">
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="payInstallment(element)"
                    [disabled]="element.paid"
                    matTooltip="Paga la rata"
                  >
                    <mat-icon>payment</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>

    <ng-template #noLoanSelected>
      <mat-card class="no-loan-card">
        <mat-card-content>
          <mat-icon class="no-loan-icon">info</mat-icon>
          <p>Seleziona un finanziamento dalla lista per vederne i dettagli.</p>
          <p>Oppure aggiungine uno nuovo!</p>
        </mat-card-content>
      </mat-card>
    </ng-template>
  </div>
</div>
